# Gas Station Policy Examples

This document shows concrete examples of Turnkey policies generated by the Gas Station SDK helpers.

## Table of Contents

1. [EOA Intent Signing Policies](#eoa-intent-signing-policies)
2. [Paymaster Execution Policies](#paymaster-execution-policies)
3. [Combined Defense Examples](#combined-defense-examples)

---

## EOA Intent Signing Policies

These policies restrict what EIP-712 intents the EOA can sign. They evaluate the typed data structure before signature creation.

### Example 1: USDC Only

**Code:**

```typescript
const policy = GasStationClient.buildIntentSigningPolicy({
  organizationId: "01934f2a-8c6e-7890-b123-456789abcdef",
  eoaUserId: "01934f2a-1234-5678-9abc-def012345678",
  restrictions: {
    allowedContracts: ["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"], // USDC on Base
  },
  policyName: "USDC Only Policy",
});
```

**Generated Policy:**

```json
{
  "type": "ACTIVITY_TYPE_CREATE_POLICY_V3",
  "organizationId": "01934f2a-8c6e-7890-b123-456789abcdef",
  "parameters": {
    "policyName": "USDC Only Policy",
    "effect": "EFFECT_ALLOW",
    "consensus": "approvers.any(user, user.id == '01934f2a-1234-5678-9abc-def012345678')",
    "condition": "activity.resource == 'PRIVATE_KEY' && activity.action == 'SIGN' && eth.eip_712.message.outputContract in ['0x833589fcd6edb6e08f4c7c32d4f71b54bda02913']",
    "notes": "Restricts which EIP-712 intents the EOA can sign for gas station execution"
  }
}
```

**What it does:**

- ✅ Allows signing intents where `outputContract` is USDC
- ❌ Blocks any other contract (DAI, WETH, NFTs, etc.)
- Applies to all private keys owned by the user in this org

---

### Example 2: Multiple Stablecoins with ETH Limit

**Code:**

```typescript
const policy = GasStationClient.buildIntentSigningPolicy({
  organizationId: "01934f2a-8c6e-7890-b123-456789abcdef",
  eoaUserId: "01934f2a-1234-5678-9abc-def012345678",
  restrictions: {
    allowedContracts: [
      "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // USDC
      "0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb", // DAI
    ],
    maxEthAmount: parseEther("0.01"), // 0.01 ETH = 10000000000000000 wei
  },
  policyName: "Stablecoin with ETH Cap",
});
```

**Generated Policy:**

```json
{
  "type": "ACTIVITY_TYPE_CREATE_POLICY_V3",
  "organizationId": "01934f2a-8c6e-7890-b123-456789abcdef",
  "parameters": {
    "policyName": "Stablecoin with ETH Cap",
    "effect": "EFFECT_ALLOW",
    "consensus": "approvers.any(user, user.id == '01934f2a-1234-5678-9abc-def012345678')",
    "condition": "activity.resource == 'PRIVATE_KEY' && activity.action == 'SIGN' && eth.eip_712.message.outputContract in ['0x833589fcd6edb6e08f4c7c32d4f71b54bda02913', '0x50c5725949a6f0c72e6c4a641f24049a917db0cb'] && eth.eip_712.message.ethAmount <= 10000000000000000",
    "notes": "Restricts which EIP-712 intents the EOA can sign for gas station execution"
  }
}
```

**What it does:**

- ✅ Allows signing intents for USDC or DAI
- ✅ Allows up to 0.01 ETH value per intent
- ❌ Blocks intents with > 0.01 ETH
- ❌ Blocks any other contracts

---

### Example 3: No Restrictions (Allow All)

**Code:**

```typescript
const policy = GasStationClient.buildIntentSigningPolicy({
  organizationId: "01934f2a-8c6e-7890-b123-456789abcdef",
  eoaUserId: "01934f2a-1234-5678-9abc-def012345678",
  restrictions: {}, // No restrictions
  policyName: "Unrestricted Signing",
});
```

**Generated Policy:**

```json
{
  "type": "ACTIVITY_TYPE_CREATE_POLICY_V3",
  "organizationId": "01934f2a-8c6e-7890-b123-456789abcdef",
  "parameters": {
    "policyName": "Unrestricted Signing",
    "effect": "EFFECT_ALLOW",
    "consensus": "approvers.any(user, user.id == '01934f2a-1234-5678-9abc-def012345678')",
    "condition": "activity.resource == 'PRIVATE_KEY' && activity.action == 'SIGN'",
    "notes": "Restricts which EIP-712 intents the EOA can sign for gas station execution"
  }
}
```

**What it does:**

- ✅ Allows signing any EIP-712 intent
- No contract or ETH restrictions

---

## Paymaster Execution Policies

These policies restrict what on-chain transactions the paymaster can submit. They parse the packed bytes encoding in `execute(address eoaAddress, bytes data)`.

### Example 1: Specific EOA and Contracts

**Code:**

```typescript
const policy = GasStationClient.buildPaymasterExecutionPolicy({
  organizationId: "org-paymaster-abc",
  paymasterUserId: "paymaster-user-123",
  executionContractAddress: "0x576A4D741b96996cc93B4919a04c16545734481f",
  restrictions: {
    allowedEOAs: ["0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"],
    allowedContracts: ["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"], // USDC
  },
  policyName: "Paymaster Protection",
});
```

**Generated Policy:**

```json
{
  "type": "ACTIVITY_TYPE_CREATE_POLICY_V3",
  "organizationId": "org-paymaster-abc",
  "parameters": {
    "policyName": "Paymaster Protection",
    "effect": "EFFECT_ALLOW",
    "consensus": "approvers.any(user, user.id == 'paymaster-user-123')",
    "condition": "activity.resource == 'PRIVATE_KEY' && activity.action == 'SIGN' && eth.tx.to == '0x576a4d741b96996cc93b4919a04c16545734481f' && (eth.tx.data[300..340] == '833589fcd6edb6e08f4c7c32d4f71b54bda02913') && (eth.tx.data[10..74] == '000000000000000000000000742d35cc6634c0532925a3b844bc9e7595f0beb')",
    "notes": "Restricts which execute() transactions the paymaster can submit on-chain"
  }
}
```

**What it does:**

- ✅ Allows calling the execution contract
- ✅ Only for EOA `0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb`
- ✅ Only for output contract USDC
- ❌ Blocks execution for any other EOA or contract

**Byte parsing:**

- `eth.tx.data[10..74]` = EOA address (first parameter to `execute()`)
- `eth.tx.data[300..340]` = Output contract address (from packed bytes)

---

### Example 2: Multiple EOAs with Gas Limits

**Code:**

```typescript
const policy = GasStationClient.buildPaymasterExecutionPolicy({
  organizationId: "org-paymaster-abc",
  paymasterUserId: "paymaster-user-123",
  executionContractAddress: "0x576A4D741b96996cc93B4919a04c16545734481f",
  restrictions: {
    allowedEOAs: [
      "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
      "0x1234567890123456789012345678901234567890",
    ],
    allowedContracts: [
      "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // USDC
      "0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb", // DAI
    ],
    maxGasPrice: parseGwei("50"), // 50000000000 wei
    maxGasLimit: 500000n,
  },
  policyName: "Multi-User Paymaster",
});
```

**Generated Policy:**

```json
{
  "type": "ACTIVITY_TYPE_CREATE_POLICY_V3",
  "organizationId": "org-paymaster-abc",
  "parameters": {
    "policyName": "Multi-User Paymaster",
    "effect": "EFFECT_ALLOW",
    "consensus": "approvers.any(user, user.id == 'paymaster-user-123')",
    "condition": "activity.resource == 'PRIVATE_KEY' && activity.action == 'SIGN' && eth.tx.to == '0x576a4d741b96996cc93b4919a04c16545734481f' && (eth.tx.data[300..340] == '833589fcd6edb6e08f4c7c32d4f71b54bda02913' || eth.tx.data[300..340] == '50c5725949a6f0c72e6c4a641f24049a917db0cb') && (eth.tx.data[10..74] == '000000000000000000000000742d35cc6634c0532925a3b844bc9e7595f0beb' || eth.tx.data[10..74] == '0000000000000000000000001234567890123456789012345678901234567890') && eth.tx.gasPrice <= 50000000000 && eth.tx.gas <= 500000",
    "notes": "Restricts which execute() transactions the paymaster can submit on-chain"
  }
}
```

**What it does:**

- ✅ Allows execution for 2 EOAs
- ✅ Allows USDC or DAI as output contracts
- ✅ Gas price must be ≤ 50 gwei
- ✅ Gas limit must be ≤ 500,000
- ❌ Blocks high gas prices (DoS protection)
- ❌ Blocks excessive gas limits (cost protection)

---

### Example 3: Unrestricted Paymaster (Dangerous!)

**Code:**

```typescript
const policy = GasStationClient.buildPaymasterExecutionPolicy({
  organizationId: "org-paymaster-abc",
  paymasterUserId: "paymaster-user-123",
  executionContractAddress: "0x576A4D741b96996cc93B4919a04c16545734481f",
  restrictions: {}, // No restrictions!
  policyName: "Unrestricted Paymaster",
});
```

**Generated Policy:**

```json
{
  "type": "ACTIVITY_TYPE_CREATE_POLICY_V3",
  "organizationId": "org-paymaster-abc",
  "parameters": {
    "policyName": "Unrestricted Paymaster",
    "effect": "EFFECT_ALLOW",
    "consensus": "approvers.any(user, user.id == 'paymaster-user-123')",
    "condition": "activity.resource == 'PRIVATE_KEY' && activity.action == 'SIGN' && eth.tx.to == '0x576a4d741b96996cc93b4919a04c16545734481f'",
    "notes": "Restricts which execute() transactions the paymaster can submit on-chain"
  }
}
```

**What it does:**

- ✅ Allows execution to the gas station contract
- ✅ No EOA restrictions
- ✅ No contract restrictions
- ✅ No gas restrictions
- ⚠️ **Warning:** Extremely permissive! Use with caution.

---

## Combined Defense Examples

### Example: Defense in Depth

```typescript
// Layer 1: EOA can only sign USDC intents
const eoaPolicy = GasStationClient.buildIntentSigningPolicy({
  organizationId: "org-alice",
  eoaUserId: "alice-user-id",
  restrictions: {
    allowedContracts: ["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"],
    maxEthAmount: 0n, // No ETH transfers
  },
});

// Layer 2: Paymaster can only execute for Alice, USDC only, with gas limits
const paymasterPolicy = GasStationClient.buildPaymasterExecutionPolicy({
  organizationId: "org-paymaster",
  paymasterUserId: "paymaster-user-id",
  executionContractAddress: "0x576A4D741b96996cc93B4919a04c16545734481f",
  restrictions: {
    allowedEOAs: ["0xAlice..."],
    allowedContracts: ["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"],
    maxGasPrice: parseGwei("50"),
    maxGasLimit: 500000n,
  },
});
```

**Attack Scenarios:**

| Attack                                  | Layer 1 (EOA)         | Layer 2 (Paymaster)           | Result               |
| --------------------------------------- | --------------------- | ----------------------------- | -------------------- |
| Stolen signature for WETH               | ❌ Blocked (not USDC) | N/A                           | Attack fails         |
| Valid USDC signature                    | ✅ Allowed            | ✅ Allowed                    | Transaction succeeds |
| Compromised paymaster tries unknown EOA | N/A                   | ❌ Blocked (not in allowlist) | Attack fails         |
| Compromised paymaster + high gas price  | N/A                   | ❌ Blocked (exceeds limit)    | Attack fails         |

**Defense layers:**

1. **Cryptographic signing restrictions** (EOA policy)
2. **On-chain execution restrictions** (Paymaster policy)
3. Both enforced by Turnkey's policy engine

---

## Policy Management Best Practices

### 1. Start Restrictive, Relax Later

```typescript
// Start with tight restrictions
const initialPolicy = buildIntentSigningPolicy({
  restrictions: {
    allowedContracts: [USDC_ADDRESS], // Only USDC
    maxEthAmount: 0n, // No ETH
  },
});

// Later, expand as needed
const relaxedPolicy = buildIntentSigningPolicy({
  restrictions: {
    allowedContracts: [USDC_ADDRESS, DAI_ADDRESS, USDT_ADDRESS],
    maxEthAmount: parseEther("0.01"),
  },
});
```

### 2. Use Organization-Wide for Dedicated Orgs

```typescript
// If the org is dedicated to gas station EOAs, no selector needed
// Policy applies to all keys in org
```

### 3. Monitor and Audit

```typescript
// Log policy violations
// Review Turnkey activity logs regularly
// Update policies based on usage patterns
```

### 4. Test Policies Before Production

```typescript
// Create restrictive test policy
// Verify it blocks unwanted actions
// Verify it allows intended actions
// Then deploy to production
```

---

## Troubleshooting

### Policy Rejects Valid Transaction

**Check:**

1. Address casing (policies use lowercase)
2. ETH amount in wei (not ETH)
3. Condition syntax (run in Turnkey policy playground)

### Policy Allows Unwanted Transaction

**Check:**

1. Condition logic (AND vs OR)
2. Missing restrictions
3. Byte offset calculations (for paymaster policies)

### Can't Create Policy

**Check:**

1. Organization ID is correct
2. User ID exists
3. Consensus references valid user
4. Activity type is supported

---

## Additional Resources

- [Turnkey Policy Language Documentation](https://docs.turnkey.com/concepts/policies/language)
- [Create Policy API Reference](https://docs.turnkey.com/api-reference/activities/create-policy)
- [Gas Station Examples](./src/examples/)

